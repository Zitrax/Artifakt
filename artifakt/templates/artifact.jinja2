<!DOCTYPE html>
<html lang="{{ request.locale_name }}">
<head>
    {% include 'head.jinja2' %}
    <title>Artifact {{ artifact.name }}</title>
    <script src="/js/artifact.js"></script>
    <script src="/js/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="/css/jquery-ui.min.css">

</head>
<body>
{% include 'navbar.jinja2' %}
<div class="container">

    {% if artifact.exists or artifact.is_bundle %}
        <div class="panel panel-success">
    {% else %}
        <div class="alert alert-danger" role="alert">
            <strong>File not found</strong> This file is missing on disk.
        </div>

        <div class="panel panel-danger">
    {% endif %}
    <div class="panel-heading">
        <h3 id="filename" class="panel-title"><b>
            {% if artifact.is_bundle %}
                <span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span>&nbsp;{{ artifact.name }}
            {% else %}
                {{ artifact.name }}
            {% endif %}
        </b></h3>
    </div>

    <div class="panel-body">
        {% if artifact.is_bundle %}
            <table class="table table-striped table-hover table-condensed">
                <tr>
                    <th>Filename</th>
                    <th>SHA1</th>
                    <th>Created</th>
                    <th>Comment</th>
                </tr>
                {% for artifact in artifact.artifacts %}
                    <tr>
                        <td><a href="/artifact/{{ artifact.sha1 }}">{{ artifact.filename }}</a></td>
                        <td><code>{{ artifact.sha1 }}</code></td>
                        <td>{{ artifact.created }}</td>
                        <td>{{ artifact.comment if artifact.comment else '' }}</td>
                    </tr>
                {% endfor %}
            </table>
        {% else %}
            <table class="table table-striped table-hover">
                <tr>
                    <th>File size</th>
                    <td id="file_size">{{ artifact.size_h }} ({{ artifact.size }} bytes)</td>
                </tr>
                <tr>
                    <th>SHA1</th>
                    <td><code>{{ artifact.sha1 }}</code></td>
                </tr>
                <tr>
                    <th>Created</th>
                    <td>
                        <script>
                            document.write(new Date('{{ artifact.created }} UTC').toLocaleString());
                        </script>
                        ( {{ artifact.age }} ago )
                    </td>
                </tr>
                <tr>
                    <th>Uploader</th>
                    <td>{{ artifact.uploader.username if not artifact.uploader.firstname else
                 "{} {}".format(artifact.uploader.firstname, artifact.uploader.lastname) }}</td>
                </tr>
                <tr>
                    <th>Mime type</th>
                    <td>{{ artifact.mime or "Unknown" }}</td>
                </tr>
                {% if artifact.bundles %}
                    <tr>
                        <th>Bundles</th>
                        <td>
                            {% for bundle in artifact.bundles %}
                                <code><a href="/artifact/{{ bundle.sha1 }}">{{ bundle.name }}</a></code>
                            {% endfor %}
                        </td>
                    </tr>
                {% endif %}
                {% if artifact.comment %}
                    <tr>
                        <th>Comment</th>
                        <td>{{ artifact.comment }}</td>
                    </tr>
                {% endif %}

                {% if artifact.vcs is not none %}
                    <tr class="info">
                        <th colspan="2">Version information</th>
                    </tr>
                    <tr>
                        <th>Repository</th>
                        <td>{{ artifact.vcs.repository.name }}</td>
                    </tr>
                    <tr>
                        <th>Type</th>
                        <td>{{ artifact.vcs.repository.type }}</td>
                    </tr>
                    <tr>
                        <th>Revision</th>
                        <td>{{ artifact.vcs.revision }}</td>
                    </tr>
                {% endif %}

            </table>
        {% endif %}

        {% if artifact.exists %}
            <form style="display: inline;" action="/artifact/{{ artifact.sha1 }}/download">
                <input type="submit" class="btn btn-sm btn-success" value="Download">
            </form>
            <form style="display: inline;" class="view_content" action="/artifact/{{ artifact.sha1 }}/view_raw">
                <input type="submit" class="btn btn-sm btn-primary" value="View raw">
            </form>
            {% if artifact.is_archive %}
                <form style="display: inline;" action="/artifact/{{ artifact.sha1 }}/view_archive">
                    <button type="submit" class="btn btn-sm btn-primary">
                        <span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span>&nbsp;&nbsp;View archive
                    </button>
                </form>
            {% endif %}
            {% if artifact.is_text %}
                <form style="display: inline;" class="view_content" action="/artifact/{{ artifact.sha1 }}/view">
                    <input type="submit" class="btn btn-sm btn-primary" value="View highlight">
                </form>
            {% endif %}
        {% endif %}
        <form style="display: inline;" id="delete" action="/artifact/{{ artifact.sha1 }}/delete">
            <button type="submit" class="btn btn-sm btn-danger">
                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>&nbsp;Delete
            </button>
        </form>
    </div>
    </div>

    <div class="panel panel-success">
        <div class="panel-heading">
            <h3 class="panel-title">Deliveries</h3>
        </div>

        <div class="panel-body">
            <button id="add_delivery" class="btn btn-sm btn-default" type="submit">Add delivery</button>
            <hr>
            <table {% if not artifact.deliveries %} style="display: none;"{% endif %} id="deliveries"
                                                    class="table table-striped table-hover">
                <tr>
                    <th>Date</th>
                    <th>To</th>
                    <th>Comment</th>
                    <th>By</th>
                    <th></th>
                </tr>
                {% for delivery in artifact.deliveries %}
                    <tr>
                        <td>
                            <script>
                                document.write(new Date('{{ delivery.time }} UTC').toLocaleString());
                            </script>
                        </td>
                        <td>{{ delivery.to.name }}</td>
                        <td>{{ delivery.comment }}</td>
                        <td>{{ delivery.by }}</td>
                        <td>
                                <span data-id="{{ delivery.id }}"
                                      data-name="{{ delivery.to.name }}"
                                      data-time="{{ delivery.time }}"
                                      class="delete_delivery glyphicon glyphicon-trash"
                                      aria-hidden="true"></span>
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    </div>

    <div style="display: None;" id="delete_delivery_confirm" title="Delete delivery?">
        <p><span class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></span>The delivery
            record:<br>
            <b><span id="delivery_delete_name">ERROR</span></b> at <b><span
                    id="delivery_delete_time">ERROR</span></b><br>
            will be permanently removed. Are you sure?</p>
    </div>

    <div style="display: None;" id="delete_comment_confirm" title="Delete comment?">
        <p><span class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></span>The comment:<br>
            <b><span id="comment_delete_text">ERROR</span></b><br> will be permanently removed. Are you sure?</p>
    </div>

    <div class="panel panel-success">
        <div class="panel-heading">
            <h3 class="panel-title">Comments</h3>
        </div>

        <div class="panel-body">
            <input style="margin: 0 0 0 20px;" id="new_comment" class="input-sm" type="text" placeholder="New comment">
            <button id="new_comment_button" class="btn btn-sm btn-default" type="submit">Add comment</button>
            <hr>
            <ul id="comments">
                {% for comment in artifact.root_comments recursive %}
                    <li>
                        <span class="comment">{{ comment.comment }}</span>&nbsp;&mdash;&nbsp;
                        <span class="comment_by">{{ "" if comment.deleted else comment.user }}</span>
                        <span class="comment_age" title="{{ comment.time }}">{{ comment.age }} ago</span>&nbsp;
                        {% if not comment.deleted %}
                            <span class="comment_reply"><a data-comment-id="{{ comment.id }}">Reply</a></span>
                            {% if comment.user.id == request.user.id %}
                                <span data-id="{{ comment.id }}" class="delete_comment glyphicon glyphicon-trash"
                                      aria-hidden="true"></span>
                            {% endif %}
                        {% endif %}
                        {% if comment.replies %}
                            <ul>{{ loop(comment.replies) }}</ul>
                        {% endif %}
                    </li>
                {% endfor %}

            </ul>
        </div>
    </div>

    <div id="delivery-dialog" title="Create a delivery">
        <form>
            <label for="customer">Customer name</label>
            <select id="customer" name="customer" class="form-control"></select>
            <label for="delivery_comment">Comment</label>
            <input type="text" name="delivery_comment" id="delivery_comment"
                   class="form-control text ui-widget-content ui-corner-all">
            <label for="delivery_time">Delivery date</label>
            <input type="date" id="delivery_time" name="delivery_time">
            <!-- Allow form submission with keyboard without duplicating the dialog button -->
            <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
        </form>
    </div>


</body>
</html>
